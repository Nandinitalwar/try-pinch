'use client'

import React, { useState, useEffect, useRef } from 'react'
import { Message, ChatSession, UserProfile, TimePeriodPrediction } from '../lib/types'
import { PredictionService, PredictionDatabase } from '../lib/predictionService'
import { useUserProfile } from '../lib/UserProfileContext'
import { useAuth } from '../lib/AuthContext'
import { useNewChatSessions } from '../lib/useNewChatSessions'
import UserProfileSetup from '../components/UserProfileSetup'
import PredictionFeedback from '../components/PredictionFeedback'
import AuthPage from '../components/AuthPage'
import { Plus, MessageSquare, Settings, Menu, X, LogOut, User } from 'lucide-react'
import { v4 as uuidv4 } from 'uuid'

export default function Home() {
  const { user, loading: authLoading, signOut } = useAuth()
  const { userProfile, setUserProfile, contacts, isProfileComplete } = useUserProfile()
  const { chatSessions, saveMessage, deleteChatSession, updateChatTitle } = useNewChatSessions()
  const [messages, setMessages] = useState<Message[]>([])
  const [inputMessage, setInputMessage] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [showProfileModal, setShowProfileModal] = useState(false)
  const [currentChatId, setCurrentChatId] = useState<string>('')
  const [showFeedbackModal, setShowFeedbackModal] = useState(false)
  const [pendingPrediction, setPendingPrediction] = useState<TimePeriodPrediction | null>(null)
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [showAuthModal, setShowAuthModal] = useState(false)
  
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)

  // Chat sessions are now managed by the useChatSessions hook

  // Check for pending feedback when user starts chatting
  useEffect(() => {
    if (userProfile && messages.length === 0) {
      checkForPendingFeedback()
    }
  }, [userProfile, messages])

  // Check for pending feedback
  const checkForPendingFeedback = () => {
    if (!userProfile) return
    
    const pendingPredictions = PredictionDatabase.getPendingFeedbackPredictions(userProfile.id)
    if (pendingPredictions.length > 0) {
      setPendingPrediction(pendingPredictions[0])
      setShowFeedbackModal(true)
    }
  }

  // Chat sessions are now saved to database via useChatSessions hook

  // Force profile setup if incomplete - ALWAYS show modal if profile incomplete
  useEffect(() => {
    console.log('Profile completion check:', { isProfileComplete, userProfile })
    if (!isProfileComplete) {
      console.log('Setting profile modal to true')
      setShowProfileModal(true)
    }
  }, [isProfileComplete])

  // Ensure modal shows on initial load
  useEffect(() => {
    console.log('Initial load - showing profile modal')
    setShowProfileModal(true)
  }, [])

  // Prevent closing modal if profile is incomplete
  const handleCloseModal = () => {
    console.log('Attempting to close modal, isProfileComplete:', isProfileComplete)
    if (!isProfileComplete) {
      console.log('Preventing modal close - profile incomplete')
      return // Don't allow closing if profile incomplete
    }
    console.log('Closing modal - profile complete')
    setShowProfileModal(false)
  }

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }

  useEffect(() => {
    scrollToBottom()
  }, [messages])

  const startNewChat = () => {
    console.log('ðŸ”„ startNewChat called')
    console.log('Current state before clearing:', { currentChatId, messagesCount: messages.length })
    
    // Don't create a chat immediately - just clear the current chat
    // Chat will be created when user sends their first message
    setCurrentChatId('')
    setMessages([])
    
    console.log('âœ… New chat state set - currentChatId cleared, messages cleared')
  }

  const loadChat = (sessionId: string) => {
    const chat = chatSessions.find(c => c.id === sessionId)
    if (chat) {
      setCurrentChatId(sessionId)
      // Convert ChatMessage[] to Message[] format
      const convertedMessages: Message[] = chat.messages.map(msg => ({
        id: msg.id || `msg_${Date.now()}`,
        role: msg.role,
        content: msg.message,
        timestamp: msg.created_at || new Date(),
        userProfile: userProfile
      }))
      setMessages(convertedMessages)
      setSidebarOpen(false) // Close sidebar on mobile when chat is loaded
    }
  }

  const deleteChat = async (sessionId: string) => {
    try {
      await deleteChatSession(sessionId)
      if (currentChatId === sessionId) {
        setCurrentChatId('')
        setMessages([])
      }
    } catch (error) {
      console.error('Failed to delete chat:', error)
    }
  }

  const handleUpdateChatTitle = async (sessionId: string, title: string) => {
    try {
      await updateChatTitle(sessionId, title)
    } catch (error) {
      console.error('Failed to update chat title:', error)
    }
  }



  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!inputMessage.trim()) return
    
    console.log('ðŸ“ handleSubmit called with message:', inputMessage)
    console.log('Current state:', { currentChatId, messagesCount: messages.length, user: !!user, userProfile: !!userProfile })
    
    if (isLoading) return

    const userMessage: Message = {
      id: `msg_${Date.now()}`,
      role: 'user',
      content: inputMessage,
      timestamp: new Date(),
      userProfile: userProfile || null
    }

    const newMessages = [...messages, userMessage]
    setMessages(newMessages)
    setInputMessage('')
    setIsLoading(true)

    // Create new chat session if none exists (only when user sends first message)
    let sessionId = currentChatId
    console.log('ðŸ” Checking if new chat session needs to be created. Current sessionId:', sessionId)
    
    if (!sessionId) {
      // Generate a proper UUID for the session
      sessionId = uuidv4()
      console.log('ðŸ†• Creating new chat session with ID:', sessionId)
      setCurrentChatId(sessionId)
      console.log('ðŸŽ¯ Current session ID set to:', sessionId)
    } else {
      console.log('â™»ï¸ Using existing session ID:', sessionId)
    }

    try {
      // Create userProfile without currentProblems field - handle null for anonymous users
      const userProfileForRequest = userProfile ? 
        (({ currentProblems, ...rest }) => rest)(userProfile) : 
        null
      
      const requestBody = {
        message: inputMessage,
        history: newMessages.map(msg => ({ role: msg.role, content: msg.content })),
        userProfile: userProfileForRequest
      }
      
      const requestHeaders = { 'Content-Type': 'application/json' }
      
      console.log('=== EXACT REQUEST TO /api/chat ===')
      console.log('Method: POST')
      console.log('URL: /api/chat')
      console.log('Headers:', JSON.stringify(requestHeaders, null, 2))
      console.log('Body:', JSON.stringify(requestBody, null, 2))
      console.log('Body size:', JSON.stringify(requestBody).length, 'characters')
      console.log('=== END REQUEST ===')

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: requestHeaders,
        body: JSON.stringify(requestBody)
      })

      console.log('=== RESPONSE FROM /api/chat ===')
      console.log('Status:', response.status)
      console.log('Status Text:', response.statusText)
      console.log('Headers:', Object.fromEntries(response.headers.entries()))
      console.log('=== END RESPONSE HEADERS ===')

      if (!response.ok) {
        const errorText = await response.text()
        console.log('Error Response Body:', errorText)
        throw new Error('Failed to get response')
      }

      const data = await response.json()
      
      const assistantMessage: Message = {
        id: `msg_${Date.now()}_assistant`,
        role: 'assistant',
        content: data.response,
        timestamp: new Date(),
        userProfile
      }

            const finalMessages = [...newMessages, assistantMessage]
      setMessages(finalMessages)

      // Save messages to database
      console.log('ðŸ’¾ Saving messages to database:', { sessionId, messageCount: finalMessages.length })
      
      // Save user message
      await saveMessage({
        session_id: sessionId,
        role: 'user',
        message: inputMessage
      })
      
      // Save assistant message
      await saveMessage({
        session_id: sessionId,
        role: 'assistant',
        message: data.response
      })
      
      console.log('âœ… Messages saved to database successfully')

      // Send SMS notification for every response (for testing)
      console.log('=== CHECKING SMS NOTIFICATION CONDITIONS ===')
      console.log('User has phone number:', !!userProfile?.phoneNumber)
      console.log('Phone number value:', userProfile?.phoneNumber)
      console.log('SMS notifications enabled:', userProfile?.smsNotifications)
      console.log('Has AI response:', !!data.response)
      
      if (userProfile?.phoneNumber && userProfile?.smsNotifications && data.response) {
        console.log('âœ… All conditions met - sending SMS notification')
        
        const smsRequestBody = {
          phoneNumber: userProfile.phoneNumber,
          message: data.response,
          userName: userProfile.name,
          type: 'prediction'
        }
        
        console.log('=== SMS REQUEST BODY ===')
        console.log('SMS request payload:', JSON.stringify(smsRequestBody, null, 2))
        
        try {
          console.log('ðŸš€ Making SMS API request to /api/sms')
          
          const smsResponse = await fetch('/api/sms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(smsRequestBody)
          })
          
          console.log('=== SMS API RESPONSE ===')
          console.log('SMS response status:', smsResponse.status)
          console.log('SMS response statusText:', smsResponse.statusText)
          console.log('SMS response headers:', Object.fromEntries(smsResponse.headers.entries()))
          
          const smsResponseBody = await smsResponse.text()
          console.log('SMS response body:', smsResponseBody)
          
          if (smsResponse.ok) {
            console.log('âœ… SMS notification sent successfully')
          } else {
            console.log('âŒ SMS API returned error status:', smsResponse.status)
          }
        } catch (error) {
          console.log('=== SMS REQUEST ERROR ===')
          console.error('âŒ Failed to send SMS notification')
          console.error('Error type:', error instanceof Error ? error.constructor.name : typeof error)
          console.error('Error message:', error instanceof Error ? error.message : String(error))
          console.error('Full error object:', error)
        }
      } else {
        console.log('âŒ SMS conditions not met - skipping SMS notification')
        if (!userProfile?.phoneNumber) console.log('  - Missing phone number')
        if (!userProfile?.smsNotifications) console.log('  - SMS notifications disabled')
        if (!data.response) console.log('  - No AI response')
      }

      // Check if AI response contains predictions - only for authenticated users with profiles
      if (data.response && userProfile) {
        const prediction = PredictionService.createPrediction(
          userProfile.id,
          userProfile.starSign,
          inputMessage,
          data.response,
          assistantMessage.id
        )

        if (prediction) {
          // Store the prediction
          PredictionDatabase.savePrediction(prediction)

          // Link the message to the prediction
          assistantMessage.predictionId = prediction.id

          // Update messages with prediction link
          setMessages(prev => prev.map(msg =>
            msg.id === assistantMessage.id ? { ...msg, predictionId: prediction.id } : msg
          ))
        }
      }
      
    } catch (error) {
      console.error('Error:', error)
      const errorMessage: Message = {
        id: `msg_${Date.now()}_error`,
        role: 'assistant',
        content: 'Sorry, I encountered an error. Please try again.',
        timestamp: new Date(),
        userProfile: userProfile || null
      }
      setMessages(prev => [...prev, errorMessage])
    } finally {
      setIsLoading(false)
    }
  }

  const clearMessages = () => {
    setMessages([])
    setCurrentChatId('')
  }

  const handleFeedbackSubmitted = () => {
    setShowFeedbackModal(false)
    setPendingPrediction(null)
    // Optionally show a success message
  }

  const handleFeedbackClose = () => {
    setShowFeedbackModal(false)
    setPendingPrediction(null)
  }

  // Auto-show profile modal when profile is incomplete
  useEffect(() => {
    console.log('Profile effect triggered:', { isProfileComplete, userProfile })
    if (!isProfileComplete) {
      console.log('Setting profile modal to true')
      setShowProfileModal(true)
    } else {
      console.log('Profile complete, hiding modal')
      setShowProfileModal(false)
    }
  }, [isProfileComplete])

  // Show loading spinner while checking authentication
  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
          <p className="text-gray-400">Loading...</p>
        </div>
      </div>
    )
  }

  // Allow anonymous usage - don't redirect to auth page anymore

  return (
    <div className="flex h-screen bg-gray-900 relative">
      {/* Mobile Sidebar Overlay */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}
      
      {/* Sidebar */}
      <div className={`
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
        md:translate-x-0
        fixed md:relative
        z-50 md:z-0
        w-64 bg-gray-800 flex flex-col
        transition-transform duration-300 ease-in-out
        h-full
      `}>
        <div className="p-4 border-b border-gray-700">
          <button
            onClick={() => {
              console.log('ðŸ–±ï¸ New Chat button clicked')
              startNewChat()
            }}
            className="w-full bg-purple-600 hover:bg-purple-700 text-white rounded-lg py-2 px-3 flex items-center justify-center gap-2 transition-colors"
          >
            <Plus size={16} />
            <span>New Chat</span>
          </button>
        </div>
        
        <div className="flex-1 overflow-y-auto">
          {user && chatSessions.map(chat => (
            <div
              key={chat.id}
              className={`p-3 border-b border-gray-700 cursor-pointer hover:bg-gray-700 transition-colors ${
                currentChatId === chat.id ? 'bg-gray-700' : ''
              }`}
              onClick={() => loadChat(chat.id)}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 min-w-0 flex-1">
                  <MessageSquare size={16} className="text-gray-400 flex-shrink-0" />
                  <span className="text-sm text-gray-300 truncate">{chat.title}</span>
                </div>
                <button
                  onClick={(e) => {
                    e.stopPropagation()
                    deleteChat(chat.id)
                  }}
                  className="text-gray-500 hover:text-red-400 transition-colors"
                >
                  <X size={14} />
                </button>
              </div>
            </div>
          ))}
          
          {!user && (
            <div className="p-4 text-center text-gray-400">
              <p className="text-sm mb-3">Sign in to save your chat history</p>
              <button
                onClick={() => {
                  setShowAuthModal(true)
                  setSidebarOpen(false)
                }}
                className="w-full bg-purple-600 hover:bg-purple-700 text-white rounded-lg py-2 px-3 text-sm transition-colors"
              >
                Sign In
              </button>
            </div>
          )}
        </div>
        
        {user && (
          <div className="p-4 border-t border-gray-700">
            <button
              onClick={signOut}
              className="w-full bg-red-600 hover:bg-red-700 text-white rounded-lg py-2 px-3 flex items-center justify-center gap-2 transition-colors text-sm"
            >
              <LogOut size={16} />
              <span>Sign Out</span>
            </button>
          </div>
        )}
      </div>

      {/* Main Chat Area */}
      <div className="flex-1 flex flex-col w-full md:w-auto">
        {/* Header */}
        <div className="bg-gray-800 border-b border-gray-700 p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {/* Mobile Menu Button */}
              <button
                onClick={() => setSidebarOpen(!sidebarOpen)}
                className="md:hidden p-2 text-gray-400 hover:text-white transition-colors"
              >
                <Menu size={24} />
              </button>
              
              <h1 className="text-xl md:text-2xl font-bold text-white wavy-logo truncate" data-text={currentChatId ? chatSessions.find(c => c.id === currentChatId)?.title || 'AstroWorld' : 'AstroWorld'}>
                {currentChatId 
                  ? chatSessions.find(c => c.id === currentChatId)?.title || 'AstroWorld'
                  : 'AstroWorld'
                }
              </h1>
            </div>
            
            <div className="flex items-center gap-2">
              {user ? (
                <>
                  {/* Profile button - only show for authenticated users */}
                  <button
                    onClick={() => {
                      console.log('Profile button clicked, current state:', { showProfileModal, isProfileComplete })
                      setShowProfileModal(true)
                      console.log('âœ… Profile modal state set to true')
                    }}
                    className="rounded-lg py-2 px-3 text-sm md:text-base bg-gray-700 hover:bg-gray-600 text-white transition-colors"
                  >
                    Profile
                  </button>
                  
                  {/* Logout button */}
                  <button
                    onClick={signOut}
                    className="rounded-lg p-2 text-gray-400 hover:text-white hover:bg-gray-700 transition-colors"
                    title="Sign out"
                  >
                    <LogOut size={18} />
                  </button>
                </>
              ) : (
                {/* Login button for anonymous users */}
                <button
                  onClick={() => setShowAuthModal(true)}
                  className="rounded-lg py-2 px-3 md:px-4 text-sm md:text-base bg-purple-600 hover:bg-purple-700 text-white transition-colors flex items-center gap-2"
                >
                  <User size={16} />
                  <span className="hidden sm:inline">Log in</span>
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Messages */}
        <div className="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 md:space-y-4">
          {messages.length === 0 ? (
            <div className="text-center text-gray-400 mt-8 md:mt-20 px-2">
              <h2 className="text-2xl md:text-3xl font-bold mb-2 wavy-logo text-white" data-text="Welcome to AstroWorld">Welcome to AstroWorld</h2>
              <p className="mb-6 text-sm md:text-base">Ask me anything about your astrological future!</p>
              
              {/* Suggested Questions */}
              <div className="max-w-2xl mx-auto px-2">
                <div className="grid grid-cols-1 gap-2 md:gap-3">
                      {[
                        "What does this week hold for my career?",
                        "When will I find love?",
                        "Should I make a major life change this month?",
                        "What are my financial prospects this year?",
                        "How will my health be in the coming months?",
                        "What opportunities should I watch for?"
                      ].map((question, index) => (
                        <button
                          key={index}
                          onClick={() => {
                            setInputMessage(question)
                            inputRef.current?.focus()
                            setSidebarOpen(false) // Close sidebar on mobile when question is selected
                          }}
                          className="p-2 md:p-3 bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-purple-500 rounded-lg text-left text-xs md:text-sm text-gray-300 hover:text-white transition-all duration-200"
                        >
                          {question}
                        </button>
                      ))}
                    </div>
                  </div>
                </>
              )}
            </div>
          ) : (
            messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[85%] md:max-w-[70%] rounded-lg px-3 md:px-4 py-2 ${
                    message.role === 'user'
                      ? 'bg-purple-600 text-white'
                      : 'bg-gray-800 text-gray-100'
                  }`}
                >
                  <div className="whitespace-pre-wrap leading-relaxed">
                    {message.content.split('\n').map((line, index) => (
                      <span key={index}>
                        {line}
                        {index < message.content.split('\n').length - 1 && <br />}
                      </span>
                    ))}
                  </div>
                  {message.predictionId && (
                    <div className="mt-2 text-xs text-purple-300">
                      ðŸ“… This response contains a prediction
                    </div>
                  )}
                </div>
              </div>
            ))
          )}
          
          {isLoading && (
            <div className="flex justify-start">
              <div className="bg-gray-800 rounded-lg px-4 py-2">
                <div className="flex space-x-1">
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                </div>
              </div>
            </div>
          )}
          
          <div ref={messagesEndRef} />
        </div>

        {/* Input Form */}
        <div className="p-3 md:p-4 border-t border-gray-700 safe-area-bottom">
          <form onSubmit={handleSubmit} className="flex gap-2">
            <input
              ref={inputRef}
              type="text"
              value={inputMessage}
              onChange={(e) => setInputMessage(e.target.value)}
              placeholder="Ask about your astrological future..."
              className="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 md:px-4 py-2 md:py-2 text-sm md:text-base text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none min-h-[44px]"
              disabled={isLoading}
            />
            <button
              type="submit"
              disabled={isLoading || !inputMessage.trim()}
              className={`rounded-lg px-3 md:px-6 py-2 text-xs md:text-sm min-h-[44px] transition-colors ${
                isLoading || !inputMessage.trim()
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  : 'bg-purple-600 hover:bg-purple-700 text-white'
              }`}
            >
              Send
            </button>
          </form>
        </div>
      </div>

      {/* Profile Modal - Show when requested */}
      {showProfileModal && (() => {
        console.log('ðŸŽ¯ Rendering profile modal:', { showProfileModal, isProfileComplete })
        return true
      })() && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 md:p-4">
          <div className="bg-gray-800 rounded-lg p-4 md:p-6 max-w-2xl w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto overflow-x-visible">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg md:text-xl font-semibold text-white">
                {isProfileComplete ? 'Edit Your Profile' : 'Complete Your Profile'}
              </h2>
              <button
                onClick={handleCloseModal}
                className="text-gray-400 hover:text-white p-1"
              >
                <X size={20} className="md:w-6 md:h-6" />
              </button>
            </div>
            <UserProfileSetup onClose={() => setShowProfileModal(false)} />
          </div>
        </div>
      )}

      {/* Auth Modal */}
      {showAuthModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 md:p-4">
          <div className="bg-gray-800 rounded-lg p-4 md:p-6 max-w-md w-full max-h-[95vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg md:text-xl font-semibold text-white">
                Welcome to AstroWorld
              </h2>
              <button
                onClick={() => setShowAuthModal(false)}
                className="text-gray-400 hover:text-white p-1"
              >
                <X size={20} />
              </button>
            </div>
            <AuthPage onClose={() => setShowAuthModal(false)} />
          </div>
        </div>
      )}

      {/* Feedback Modal */}
      {showFeedbackModal && pendingPrediction && (
        <PredictionFeedback
          prediction={pendingPrediction}
          onFeedbackSubmitted={handleFeedbackSubmitted}
          onClose={handleFeedbackClose}
        />
      )}
    </div>
  )
} 