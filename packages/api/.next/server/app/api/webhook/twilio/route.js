"use strict";(()=>{var e={};e.id=950,e.ids=[950],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7930:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>eR,patchFetch:()=>eS,requestAsyncStorage:()=>eC,routeModule:()=>eO,serverHooks:()=>eI,staticGenerationAsyncStorage:()=>eA});var r,n,s,i,a,l,c,u,h,d,g,m,p={};o.r(p),o.d(p,{GET:()=>ev,POST:()=>eT});var f=o(3036),y=o(5736),E=o(5262),b=o(942),_=o(9339);let w=require("node:crypto"),T={randomUUID:w.randomUUID},v=new Uint8Array(256),O=v.length,C=[];for(let e=0;e<256;++e)C.push((e+256).toString(16).slice(1));let A=function(e,t,o){return!T.randomUUID||t||e?function(e,t,o){let r=(e=e||{}).random??e.rng?.()??(O>v.length-16&&((0,w.randomFillSync)(v),O=0),v.slice(O,O+=16));if(r.length<16)throw Error("Random bytes length must be >= 16");if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){if((o=o||0)<0||o+16>t.length)throw RangeError(`UUID byte range ${o}:${o+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[o+e]=r[e];return t}return function(e,t=0){return(C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]).toLowerCase()}(r)}(e,t,o):T.randomUUID()};var I=o(5655);let R=new Map,S=new Map;class k{static async userProfileExists(e){if(!e)return!1;let{data:t,error:o}=await I.O.from("user_profiles").select("id").eq("phone_number",e).single();return!o&&!!t}static async getOrCreateSession(e){let t=R.get(e);if(t)return t;let o=A();return R.set(e,o),o}static async getOrCreateUser(e){let t=e?.trim();return t?(S.has(t)||S.set(t,[]),t):null}static async saveMessage(e,t,o,r,n){try{if(!e||""===e.trim())return console.error("saveMessage: identifier is empty or null"),null;let n=e.trim(),s=r||await this.getOrCreateSession(n),i={id:A(),phone_number:n,session_id:s,role:t,message:o,created_at:new Date().toISOString()},a=S.get(n)||[];if(a.push(i),S.set(n,a),I.O){let{error:e}=await I.O.from("sms_chats").insert({phone_number:n,session_id:s,role:t,message:o});e?console.error("[ChatStorage] Error persisting chat:",e.message):console.log(`[ChatStorage] Chat persisted for ${n}`)}return i}catch(e){return console.error("Error in saveMessage:",e),null}}static async getConversationHistory(e,t=20){try{let o=e?.trim();if(!o)return[];let r=S.get(o)||[],n=R.get(o);if(r.length>0)return(n?r.filter(e=>e.session_id===n):r).slice(-t);if(I.O){let{data:e,error:r}=await I.O.from("sms_chats").select("*").eq("phone_number",o).order("created_at",{ascending:!0}).limit(t);if(!r&&e&&e.length>0){console.log(`[ChatStorage] Loaded ${e.length} messages from Supabase for ${o}`);let t=e.map(e=>({id:e.id,phone_number:o,session_id:e.session_id,role:e.role,message:e.message,created_at:e.created_at}));return S.set(o,t),t.length>0&&R.set(o,t[t.length-1].session_id),t}}return[]}catch(e){return console.error("Error in getConversationHistory:",e),[]}}static formatForOpenAI(e){return e.map(e=>({role:e.role,content:e.message}))}static async startNewSession(e){let t=A();return R.set(e,t),t}static async getUserMemories(e){if(!e)return[];let{data:t,error:o}=await I.O.from("user_memories").select("memory_content, memory_type, importance").eq("phone_number",e).order("importance",{ascending:!1});return o?(console.error("Error fetching memories:",o),[]):t||[]}}class N{register(e,t){this.agents.set(e.getId(),e),this.agentsByTask.has(t)||this.agentsByTask.set(t,[]),this.agentsByTask.get(t).push(e.getId()),console.log(`Registered agent ${e.getId()} for task type: ${t}`)}getAgent(e){return this.agents.get(e)}getAgentsByTaskType(e){return(this.agentsByTask.get(e)||[]).map(e=>this.agents.get(e)).filter(e=>void 0!==e)}removeAgent(e){this.agents.get(e)&&(this.agents.delete(e),Array.from(this.agentsByTask.entries()).forEach(([t,o])=>{let r=o.indexOf(e);r>-1&&o.splice(r,1)}),console.log(`Removed agent ${e}`))}getAllAgents(){return Array.from(this.agents.values())}clear(){this.agents.clear(),this.agentsByTask.clear()}constructor(){this.agents=new Map,this.agentsByTask=new Map}}(function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"})(r||(r={})),function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"}(n||(n={})),function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"}(s||(s={}));let M=["user","model","function","system"];(function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",e.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(i||(i={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(a||(a={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(l||(l={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(c||(c={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.BLOCKLIST="BLOCKLIST",e.PROHIBITED_CONTENT="PROHIBITED_CONTENT",e.SPII="SPII",e.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",e.OTHER="OTHER"}(u||(u={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(h||(h={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(d||(d={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"}(g||(g={}));class x extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class P extends x{constructor(e,t){super(e),this.response=t}}class D extends x{constructor(e,t,o,r){super(e),this.status=t,this.statusText=o,this.errorDetails=r}}class L extends x{}class U extends x{}!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(m||(m={}));class ${constructor(e,t,o,r,n){this.model=e,this.task=t,this.apiKey=o,this.stream=r,this.requestOptions=n}toString(){var e,t;let o=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta",r=(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com",n=`${r}/${o}/${this.model}:${this.task}`;return this.stream&&(n+="?alt=sse"),n}}async function j(e){var t;let o=new Headers;o.append("Content-Type","application/json"),o.append("x-goog-api-client",function(e){let t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.24.1"),t.join(" ")}(e.requestOptions)),o.append("x-goog-api-key",e.apiKey);let r=null===(t=e.requestOptions)||void 0===t?void 0:t.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(e){throw new L(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${e.message}`)}for(let[e,t]of r.entries()){if("x-goog-api-key"===e)throw new L(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new L(`Header name ${e} can only be set using the apiClient field`);o.append(e,t)}}return o}async function G(e,t,o,r,n,s){let i=new $(e,t,o,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},function(e){let t={};if((null==e?void 0:e.signal)!==void 0||(null==e?void 0:e.timeout)>=0){let o=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>o.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{o.abort()}),t.signal=o.signal}return t}(s)),{method:"POST",headers:await j(i),body:n})}}async function Y(e,t,o,r,n,s={},i=fetch){let{url:a,fetchOptions:l}=await G(e,t,o,r,n,s);return H(a,l,i)}async function H(e,t,o=fetch){let r;try{r=await o(e,t)}catch(t){(function(e,t){let o=e;throw"AbortError"===o.name?(o=new U(`Request aborted when fetching ${t.toString()}: ${e.message}`)).stack=e.stack:e instanceof D||e instanceof L||((o=new x(`Error fetching from ${t.toString()}: ${e.message}`)).stack=e.stack),o})(t,e)}return r.ok||await B(r,e),r}async function B(e,t){let o,r="";try{let t=await e.json();r=t.error.message,t.error.details&&(r+=` ${JSON.stringify(t.error.details)}`,o=t.error.details)}catch(e){}throw new D(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${r}`,e.status,e.statusText,o)}function F(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),K(e.candidates[0]))throw new P(`${W(e)}`,e);return function(e){var t,o,r,n;let s=[];if(null===(o=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===o?void 0:o.parts)for(let t of null===(n=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===n?void 0:n.parts)t.text&&s.push(t.text),t.executableCode&&s.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&s.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return s.length>0?s.join(""):""}(e)}if(e.promptFeedback)throw new P(`Text not available. ${W(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),K(e.candidates[0]))throw new P(`${W(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),V(e)[0]}if(e.promptFeedback)throw new P(`Function call not available. ${W(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),K(e.candidates[0]))throw new P(`${W(e)}`,e);return V(e)}if(e.promptFeedback)throw new P(`Function call not available. ${W(e)}`,e)},e}function V(e){var t,o,r,n;let s=[];if(null===(o=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===o?void 0:o.parts)for(let t of null===(n=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===n?void 0:n.parts)t.functionCall&&s.push(t.functionCall);return s.length>0?s:void 0}let q=[u.RECITATION,u.SAFETY,u.LANGUAGE];function K(e){return!!e.finishReason&&q.includes(e.finishReason)}function W(e){var t,o,r;let n="";if((!e.candidates||0===e.candidates.length)&&e.promptFeedback)n+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(n+=` due to ${e.promptFeedback.blockReason}`),(null===(o=e.promptFeedback)||void 0===o?void 0:o.blockReasonMessage)&&(n+=`: ${e.promptFeedback.blockReasonMessage}`);else if(null===(r=e.candidates)||void 0===r?void 0:r[0]){let t=e.candidates[0];K(t)&&(n+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(n+=`: ${t.finishMessage}`))}return n}function J(e){return this instanceof J?(this.v=e,this):new J(e)}"function"==typeof SuppressedError&&SuppressedError;let z=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function X(e){let t=[],o=e.getReader();for(;;){let{done:e,value:r}=await o.read();if(e)return F(function(e){let t=e[e.length-1],o={promptFeedback:null==t?void 0:t.promptFeedback};for(let t of e){if(t.candidates){let e=0;for(let r of t.candidates)if(o.candidates||(o.candidates=[]),o.candidates[e]||(o.candidates[e]={index:e}),o.candidates[e].citationMetadata=r.citationMetadata,o.candidates[e].groundingMetadata=r.groundingMetadata,o.candidates[e].finishReason=r.finishReason,o.candidates[e].finishMessage=r.finishMessage,o.candidates[e].safetyRatings=r.safetyRatings,r.content&&r.content.parts){o.candidates[e].content||(o.candidates[e].content={role:r.content.role||"user",parts:[]});let t={};for(let n of r.content.parts)n.text&&(t.text=n.text),n.functionCall&&(t.functionCall=n.functionCall),n.executableCode&&(t.executableCode=n.executableCode),n.codeExecutionResult&&(t.codeExecutionResult=n.codeExecutionResult),0===Object.keys(t).length&&(t.text=""),o.candidates[e].content.parts.push(t)}e++}t.usageMetadata&&(o.usageMetadata=t.usageMetadata)}return o}(t));t.push(r)}}async function Q(e,t,o,r){return function(e){let[t,o]=(function(e){let t=e.getReader();return new ReadableStream({start(e){let o="";return function r(){return t.read().then(({value:t,done:n})=>{let s;if(n){if(o.trim()){e.error(new x("Failed to parse stream"));return}e.close();return}let i=(o+=t).match(z);for(;i;){try{s=JSON.parse(i[1])}catch(t){e.error(new x(`Error parsing JSON response: "${i[1]}"`));return}e.enqueue(s),i=(o=o.substring(i[0].length)).match(z)}return r()}).catch(e=>{let t=e;throw t.stack=e.stack,t="AbortError"===t.name?new U("Request aborted when reading from the stream"):new x("Error reading from the stream")})}()}})})(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))).tee();return{stream:function(e){return function(e,t,o){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var r,n=o.apply(e,t||[]),s=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){n[e]&&(r[e]=function(t){return new Promise(function(o,r){s.push([e,t,o,r])>1||a(e,t)})})}function a(e,t){try{var o;(o=n[e](t)).value instanceof J?Promise.resolve(o.value.v).then(l,c):u(s[0][2],o)}catch(e){u(s[0][3],e)}}function l(e){a("next",e)}function c(e){a("throw",e)}function u(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,function*(){let t=e.getReader();for(;;){let{value:e,done:o}=yield J(t.read());if(o)break;yield yield J(F(e))}})}(t),response:X(o)}}(await Y(t,m.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(o),r))}async function Z(e,t,o,r){let n=await Y(t,m.GENERATE_CONTENT,e,!1,JSON.stringify(o),r);return{response:F(await n.json())}}function ee(e){if(null!=e){if("string"==typeof e)return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)return e.role?e:{role:"system",parts:e.parts}}}function et(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(let o of e)"string"==typeof o?t.push({text:o}):t.push(o);return function(e){let t={role:"user",parts:[]},o={role:"function",parts:[]},r=!1,n=!1;for(let s of e)"functionResponse"in s?(o.parts.push(s),n=!0):(t.parts.push(s),r=!0);if(r&&n)throw new x("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!n)throw new x("No content is provided for sending chat message.");return r?t:o}(t)}function eo(e){let t;return t=e.contents?e:{contents:[et(e)]},e.systemInstruction&&(t.systemInstruction=ee(e.systemInstruction)),t}let er=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],en={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function es(e){var t;if(void 0===e.candidates||0===e.candidates.length)return!1;let o=null===(t=e.candidates[0])||void 0===t?void 0:t.content;if(void 0===o||void 0===o.parts||0===o.parts.length)return!1;for(let e of o.parts)if(void 0===e||0===Object.keys(e).length||void 0!==e.text&&""===e.text)return!1;return!0}let ei="SILENT_ERROR";class ea{constructor(e,t,o,r={}){this.model=t,this.params=o,this._requestOptions=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==o?void 0:o.history)&&(function(e){let t=!1;for(let o of e){let{role:e,parts:r}=o;if(!t&&"user"!==e)throw new x(`First content should be with role 'user', got ${e}`);if(!M.includes(e))throw new x(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(M)}`);if(!Array.isArray(r))throw new x("Content should have 'parts' property with an array of Parts");if(0===r.length)throw new x("Each Content should have at least one part");let n={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let e of r)for(let t of er)t in e&&(n[t]+=1);let s=en[e];for(let t of er)if(!s.includes(t)&&n[t]>0)throw new x(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(o.history),this._history=o.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var o,r,n,s,i,a;let l;await this._sendPromise;let c=et(e),u={safetySettings:null===(o=this.params)||void 0===o?void 0:o.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(n=this.params)||void 0===n?void 0:n.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(a=this.params)||void 0===a?void 0:a.cachedContent,contents:[...this._history,c]},h=Object.assign(Object.assign({},this._requestOptions),t);return this._sendPromise=this._sendPromise.then(()=>Z(this._apiKey,this.model,u,h)).then(e=>{var t;if(es(e.response)){this._history.push(c);let o=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(o)}else{let t=W(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e}).catch(e=>{throw this._sendPromise=Promise.resolve(),e}),await this._sendPromise,l}async sendMessageStream(e,t={}){var o,r,n,s,i,a;await this._sendPromise;let l=et(e),c={safetySettings:null===(o=this.params)||void 0===o?void 0:o.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(n=this.params)||void 0===n?void 0:n.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(a=this.params)||void 0===a?void 0:a.cachedContent,contents:[...this._history,l]},u=Object.assign(Object.assign({},this._requestOptions),t),h=Q(this._apiKey,this.model,c,u);return this._sendPromise=this._sendPromise.then(()=>h).catch(e=>{throw Error(ei)}).then(e=>e.response).then(e=>{if(es(e)){this._history.push(l);let t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{let t=W(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==ei&&console.error(e)}),h}}async function el(e,t,o,r){return(await Y(t,m.COUNT_TOKENS,e,!1,JSON.stringify(o),r)).json()}async function ec(e,t,o,r){return(await Y(t,m.EMBED_CONTENT,e,!1,JSON.stringify(o),r)).json()}async function eu(e,t,o,r){let n=o.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await Y(t,m.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:n}),r)).json()}class eh{constructor(e,t,o={}){this.apiKey=e,this._requestOptions=o,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=ee(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var o;let r=eo(e),n=Object.assign(Object.assign({},this._requestOptions),t);return Z(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(o=this.cachedContent)||void 0===o?void 0:o.name},r),n)}async generateContentStream(e,t={}){var o;let r=eo(e),n=Object.assign(Object.assign({},this._requestOptions),t);return Q(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(o=this.cachedContent)||void 0===o?void 0:o.name},r),n)}startChat(e){var t;return new ea(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(t=this.cachedContent)||void 0===t?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let o=function(e,t){var o;let r={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null===(o=null==t?void 0:t.cachedContent)||void 0===o?void 0:o.name,contents:[]},n=null!=e.generateContentRequest;if(e.contents){if(n)throw new L("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=e.contents}else if(n)r=Object.assign(Object.assign({},r),e.generateContentRequest);else{let t=et(e);r.contents=[t]}return{generateContentRequest:r}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),r=Object.assign(Object.assign({},this._requestOptions),t);return el(this.apiKey,this.model,o,r)}async embedContent(e,t={}){let o="string"==typeof e||Array.isArray(e)?{content:et(e)}:e,r=Object.assign(Object.assign({},this._requestOptions),t);return ec(this.apiKey,this.model,o,r)}async batchEmbedContents(e,t={}){let o=Object.assign(Object.assign({},this._requestOptions),t);return eu(this.apiKey,this.model,e,o)}}class ed{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new x("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new eh(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,o){if(!e.name)throw new L("Cached content must contain a `name` field.");if(!e.model)throw new L("Cached content must contain a `model` field.");for(let o of["model","systemInstruction"])if((null==t?void 0:t[o])&&e[o]&&(null==t?void 0:t[o])!==e[o]){if("model"===o&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new L(`Different value for "${o}" specified in modelParams (${t[o]}) and cachedContent (${e[o]})`)}let r=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new eh(this.apiKey,r,o)}}class eg{constructor(e){if(!e)throw Error("GOOGLE_AI_API_KEY is required");this.genAI=new ed(e),this.model=this.genAI.getGenerativeModel({model:"gemini-2.5-flash",generationConfig:{responseMimeType:"application/json"}})}async decompose(e,t){let o=`You are a task decomposition system. Analyze user messages and identify what tasks need to be executed.

Return a JSON object with a "tasks" array. Each task should have:
- type: The type of task (e.g., "general_query", "reminder", "email", "calculation", "information_lookup")
- description: A clear description of what needs to be done
- priority: 1-10 (10 is highest priority)
- requiresAgent: Optional specific agent type if needed

Examples:
- "remind me to call mom tomorrow" → {"tasks": [{"type": "reminder", "description": "Set reminder to call mom tomorrow", "priority": 8}]}
- "what's my horoscope?" → {"tasks": [{"type": "general_query", "description": "Get horoscope information", "priority": 7}]}
- "send an email to john" → {"tasks": [{"type": "email", "description": "Send email to john", "priority": 9, "requiresAgent": "email"}]}

For simple conversational messages, return a single "general_query" task.

Return ONLY valid JSON object with "tasks" array, no other text.`;try{let r;let n=[];for(let e of t)n.push({role:"user"===e.role?"user":"model",parts:[{text:e.content}]});n.push({role:"user",parts:[{text:e}]});let s=(await this.model.generateContent({contents:n,systemInstruction:{parts:[{text:o}]},generationConfig:{maxOutputTokens:500,temperature:.3,responseMimeType:"application/json"}})).response.text();if(!s||""===s.trim())return console.warn("[TaskDecomposer] Empty response from Gemini, using fallback"),[{id:A(),type:"general_query",description:e,priority:5}];try{r=JSON.parse(s)}catch(t){return console.warn("[TaskDecomposer] JSON parse failed, raw response:",s.substring(0,200)),[{id:A(),type:"general_query",description:e,priority:5}]}let i=[];if(Array.isArray(r)?i=r:r.tasks&&Array.isArray(r.tasks)?i=r.tasks:r.task&&(i=[r.task]),0===i.length)return[{id:A(),type:"general_query",description:e,priority:5}];return i.map(t=>({id:A(),type:t.type||"general_query",description:t.description||e,priority:t.priority||5,requiresAgent:t.requiresAgent}))}catch(t){return console.error("[TaskDecomposer] Unexpected error:",t),[{id:A(),type:"general_query",description:e,priority:5}]}}}class em{constructor(e,t){this.logs=[],this.id=A(),this.task=e,this.context=t,this.startTime=Date.now(),this.log(`Agent ${this.constructor.name} initialized for task: ${e}`)}log(e){let t=new Date().toISOString();this.logs.push(`[${t}] ${e}`),console.log(`[${this.constructor.name}] ${e}`)}createResult(e,t,o){let r=Date.now()-this.startTime;return{agentId:this.id,task:this.task,status:e,output:t,logs:[...this.logs],metadata:{...o,duration:r,agentType:this.constructor.name}}}getId(){return this.id}getTask(){return this.task}}class ep{static{this.genAI=null}static{this.model=null}static initializeAI(){if(!this.genAI){let e=process.env.GOOGLE_AI_API_KEY,t=e?.trim().replace(/^['"]|['"]$/g,"")||"";if(!t)return console.error("GOOGLE_AI_API_KEY is not configured for BirthDataParser"),!1;this.genAI=new ed(t),this.model=this.genAI.getGenerativeModel({model:"gemini-2.5-flash"})}return!0}static async extractBirthData(e,t){let o=e.toLowerCase(),r=["birth","born","birthdate","dob","date of birth","place of birth","birthday"].some(e=>o.includes(e)),n=[/\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,/\b\d{1,2}-\d{1,2}-\d{2,4}\b/g,/\b(january|february|march|april|may|june|july|august|september|october|november|december)\s+\d{1,2}/i,/\b\d{1,2}\s+(january|february|march|april|may|june|july|august|september|october|november|december)/i].some(e=>e.test(o));if(!r&&!n)return null;if(!this.initializeAI())return console.error("[BirthDataParser] Failed to initialize AI, falling back to basic parsing"),this.extractBirthDataBasic(e);try{let o="";t&&t.length>0&&(o=t.slice(-10).map(e=>`${e.role}: ${e.content}`).join("\n"));let r=`Extract birth information from this user message. The user may be providing their birth details.

${o?`Recent conversation context:
${o}

`:""}Current message: "${e}"

Extract any of the following information if present:
- name: The user's name or preferred name
- birth_date: Date of birth in YYYY-MM-DD format. Parse dates intelligently - if user says "July 6, 1995" or "7/6/1995" (American format MM/DD/YYYY) or "6/7/1995" (European format DD/MM/YYYY), determine the most likely format based on context. American users typically use MM/DD/YYYY.
- birth_time: Time of birth in HH:MM:SS format (24-hour). If not provided, use null.
- birth_time_known: true if they provided a specific time, false otherwise
- birth_time_accuracy: "exact" if they gave a specific time, "approximate" if they said "around" or "about", "unknown" if no time given
- birth_city: City where they were born
- birth_country: Country where they were born
- birth_timezone: The IANA timezone for the birth location (e.g., "America/Los_Angeles" for California, "America/New_York" for New York, "Europe/London" for UK, "Asia/Kolkata" for India). Determine this based on the birth city/country.

IMPORTANT timezone mappings:
- California, PST, Pacific: America/Los_Angeles
- New York, EST, Eastern: America/New_York
- Chicago, CST, Central: America/Chicago
- Denver, MST, Mountain: America/Denver
- London, UK: Europe/London
- India: Asia/Kolkata
- If location is in USA and no specific city, try to infer from context or default to America/New_York

Return ONLY a valid JSON object with these fields. Use null for any field you cannot determine.
Example: {"name": "John", "birth_date": "1995-07-06", "birth_time": "14:30:00", "birth_time_known": true, "birth_time_accuracy": "exact", "birth_city": "San Francisco", "birth_country": "USA", "birth_timezone": "America/Los_Angeles"}

If no birth information is found, return: {"no_birth_data": true}`,n=(await this.model.generateContent({contents:[{role:"user",parts:[{text:r}]}],generationConfig:{maxOutputTokens:1e3,temperature:.1}})).response.text();console.log("[BirthDataParser] AI extraction response:",n);let s=n,i=n.match(/```(?:json)?\s*([\s\S]*?)```/);i&&(s=i[1].trim());let a=s.match(/\{[\s\S]*\}/);if(!a)return console.error("[BirthDataParser] No JSON found in AI response"),this.extractBirthDataBasic(e);let l=JSON.parse(a[0]);if(l.no_birth_data)return null;if(!l.birth_date)return console.log("[BirthDataParser] No birth date extracted"),null;let c={name:l.name||void 0,birth_date:l.birth_date,birth_time:l.birth_time||"12:00:00",birth_time_known:l.birth_time_known||!1,birth_time_accuracy:l.birth_time_accuracy||"unknown",birth_timezone:l.birth_timezone||"UTC",birth_city:l.birth_city||"Unknown",birth_country:l.birth_country||"Unknown"};return console.log("[BirthDataParser] Extracted birth data:",c),c}catch(t){return console.error("[BirthDataParser] AI extraction error:",t),this.extractBirthDataBasic(e)}}static extractBirthDataBasic(e){try{let t=e.match(/\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\b/);if(!t)return null;let[o,r,n,s]=t,i=parseInt(r),a=parseInt(n);return a>12&&i<=12||i>12&&([a,i]=[i,a]),{birth_date:`${s}-${i.toString().padStart(2,"0")}-${a.toString().padStart(2,"0")}`,birth_time:"12:00:00",birth_time_known:!1,birth_time_accuracy:"unknown",birth_timezone:"UTC",birth_city:"Unknown",birth_country:"Unknown"}}catch(e){return console.error("[BirthDataParser] Basic extraction error:",e),null}}static async saveBirthData(e,t){if(!I.O)return console.error("Supabase not configured"),!1;try{let{data:o,error:r}=await I.O.from("user_profiles").upsert({phone_number:e,preferred_name:t.name,birth_date:t.birth_date,birth_time:t.birth_time,birth_time_known:t.birth_time_known,birth_time_accuracy:t.birth_time_accuracy,birth_timezone:t.birth_timezone,birth_city:t.birth_city,birth_country:t.birth_country,birth_latitude:t.birth_latitude,birth_longitude:t.birth_longitude,updated_at:new Date().toISOString()},{onConflict:"phone_number"});if(r)return console.error("Error saving birth data to Supabase:",r),!1;return console.log("Birth data saved successfully:",o),!0}catch(e){return console.error("Error saving birth data:",e),!1}}}class ef{static async getUserProfile(e){if(!I.O)return console.error("Supabase not configured"),null;try{let{data:t,error:o}=await I.O.from("user_profiles").select("*").eq("phone_number",e).single();if(o){if("PGRST116"===o.code)return console.log(`No profile found for phone number: ${e}`),null;return console.error("Error fetching user profile:",o),null}return t}catch(e){return console.error("Error fetching user profile:",e),null}}static formatProfileForAgent(e){if(!e)return"No birth data or profile information available for this user.";let t=[];if(e.preferred_name&&t.push(`User's name: ${e.preferred_name}`),e.birth_date&&t.push(`Birth date: ${e.birth_date}`),e.birth_time&&e.birth_time_known){let o=e.birth_time_accuracy||"unknown";t.push(`Birth time: ${e.birth_time} (${o})`)}else t.push("Birth time: Not provided or unknown");if(e.birth_city||e.birth_country){let o=[e.birth_city,e.birth_country].filter(Boolean).join(", ");t.push(`Birth location: ${o}`)}return e.birth_timezone&&t.push(`Timezone: ${e.birth_timezone}`),t.join("\n")}}class ey{constructor(){let e=process.env.GOOGLE_AI_API_KEY,t=e?.trim().replace(/^['"]|['"]$/g,"")||"";if(!t)throw Error("GOOGLE_AI_API_KEY is not configured");this.genAI=new ed(t),this.model=this.genAI.getGenerativeModel({model:"gemini-2.5-flash"})}async extractMemories(e,t){try{let t=`Extract memorable facts about this user from their message. Focus on:
- Preferences (likes/dislikes)
- Relationships (family, friends, pets, romantic interests)
- Lifestyle (job, hobbies, living situation)
- Personal details (name, location, important facts)
- Upcoming plans and events (dates, trips, interviews, meetings — ALWAYS extract these with high importance so we can follow up later)

Only extract things that would be useful to remember in future conversations. Upcoming plans are VERY important — we want to follow up on them later (e.g. "how was your date with Ram?").

User message: "${e}"

Return as JSON array:
[
  {
    "memory_content": "hates pineapple pizza",
    "memory_type": "preference",
    "importance": 7
  }
]

Types: preference, relationship, lifestyle, personal, event, other
Importance: 1-10 (higher = more important)
- Upcoming plans/events should ALWAYS be importance 9-10
- Relationships (who they're dating, friends, family) should be importance 8-9
- Preferences should be importance 6-8`,o=(await this.model.generateContent({contents:[{parts:[{text:t}]}],generationConfig:{maxOutputTokens:2e3,temperature:.3}})).response.text();console.log("[SimpleMemory] Raw AI response:",o);let r=o.trim();r.startsWith("```json")&&(r=r.replace(/```json\s*\n?/,"").replace(/\n?\s*```$/,"")),r.startsWith("```")&&(r=r.replace(/```\s*\n?/,"").replace(/\n?\s*```$/,""));let n=r.indexOf("["),s=r.lastIndexOf("]");-1!==n&&(r=-1===s||s<n?function(e,t){let o=e.substring(t),r=[],n=0,s=!1,i=-1,a="";for(let e=0;e<o.length;e++){let t=o[e],l=e>0?o[e-1]:"";if('"'===t&&"\\"!==l&&(s=!s),!s){if("{"===t)0===n&&(i=e,a=""),n++;else if("}"===t&&0==--n&&-1!==i){a=o.substring(i,e+1);try{JSON.parse(a),r.push(a)}catch{}i=-1,a=""}}}return r.length>0?"["+r.join(",")+"]":"[]"}(r,n):r.substring(n,s+1)),console.log("[SimpleMemory] Cleaned response for parsing:",r);try{let e=JSON.parse(r).filter(e=>e.memory_content&&e.importance>=5);return console.log("[SimpleMemory] Parsed memories:",e),e}catch(e){return console.error("[SimpleMemory] JSON parse failed:",e),console.error("[SimpleMemory] Failed to parse:",r),[]}}catch(e){return console.error("Memory extraction error:",e),[]}}async storeMemories(e,t){if(!I.O)return console.error("[SimpleMemory] Supabase not configured"),!1;if(0===t.length)return console.log("[SimpleMemory] No memories to store"),!1;console.log(`[SimpleMemory] Attempting to store ${t.length} memories for ${e}`),console.log("[SimpleMemory] Memories to store:",t);try{for(let o of t){console.log("[SimpleMemory] Storing memory:",o);let{data:t,error:r}=await I.O.from("user_memories").upsert({phone_number:e,memory_content:o.memory_content,memory_type:o.memory_type,importance:o.importance},{onConflict:"phone_number,memory_content",ignoreDuplicates:!1}).select();r?(console.error("[SimpleMemory] Error storing memory:",r),console.error("[SimpleMemory] Failed memory:",o)):console.log("[SimpleMemory] Successfully stored:",t)}return console.log(`[SimpleMemory] Finished storing memories for ${e}`),!0}catch(e){return console.error("[SimpleMemory] Storage error:",e),!1}}async getMemories(e,t=10){if(!I.O)return[];try{let{data:o,error:r}=await I.O.from("user_memories").select("*").eq("phone_number",e).gte("importance",5).order("importance",{ascending:!1}).order("created_at",{ascending:!1}).limit(t);if(r)return console.error("Memory retrieval error:",r),[];return o}catch(e){return console.error("Memory retrieval error:",e),[]}}static formatMemories(e){if(0===e.length)return"No previous memories about this user.";let t="What you remember about this user:\n",o={};return e.forEach(e=>{o[e.memory_type]||(o[e.memory_type]=[]),o[e.memory_type].push(e)}),Object.entries(o).forEach(([e,o])=>{t+=`
${e.toUpperCase()}:
`,o.forEach(e=>{t+=`- ${e.memory_content}
`})}),t}}let eE=[{functionDeclarations:[{name:"search_web",description:"Search the web for real-time information like current events, restaurants, concerts, news, weather, daily horoscopes, astrology forecasts, or anything that requires up-to-date data. Use this when the user asks about specific events, places to go, things happening now, or any question that needs current information. For event queries, call this tool MULTIPLE TIMES with different specific searches to get comprehensive results. IMPORTANT: When the user asks for ANY everyday advice (food, plans, what to do, decisions), ALSO search for today's astrology forecast for their sun sign to inform your recommendation.",parameters:{type:r.OBJECT,properties:{query:{type:r.STRING,description:"The search query. Be VERY specific and always include: location, date/month/year (today is February 2026), and event type. For comprehensive event coverage, make multiple searches. For daily astrology, search for the user's sun sign forecast. Examples: 'SF Sketchfest February 2026 dates lineup', 'San Francisco art exhibits February 2026', 'Scorpio daily horoscope February 8 2026', 'astrology forecast today February 2026 transits', 'what should Taurus do today astrology'"}},required:["query"]}},{name:"save_birth_data",description:"Save the user's birth information when they share their birthday, birth time, or birth location. Call this whenever the user provides any birth-related details like date of birth, time of birth, or place of birth.",parameters:{type:r.OBJECT,properties:{name:{type:r.STRING,description:"User's preferred name if they mentioned it"},birth_date:{type:r.STRING,description:"Birth date in YYYY-MM-DD format"},birth_time:{type:r.STRING,description:"Birth time in HH:MM:SS format (24-hour). Use null if not provided."},birth_time_known:{type:r.BOOLEAN,description:"True if the user provided a specific birth time, false otherwise"},birth_time_accuracy:{type:r.STRING,description:"One of: 'exact' (specific time given), 'approximate' (said 'around' or 'about'), 'unknown' (no time given)"},birth_city:{type:r.STRING,description:"City where user was born"},birth_country:{type:r.STRING,description:"Country where user was born"},birth_timezone:{type:r.STRING,description:"IANA timezone based on birth location. Examples: America/Los_Angeles (California/PST), America/New_York (NYC/EST), America/Chicago (Central), Europe/London (UK), Asia/Kolkata (India)"}},required:["birth_date"]}}]}];class eb extends em{constructor(e,t){super(e,t);let o=process.env.GOOGLE_AI_API_KEY,r=o?.trim().replace(/^['"]|['"]$/g,"")||"";if(!r)throw Error("GOOGLE_AI_API_KEY is not configured");this.genAI=new ed(r),this.model=this.genAI.getGenerativeModel({model:"gemini-2.5-flash",tools:eE})}async searchWeb(e){try{let t=process.env.EXA_API_KEY;if(t){console.log("[GeneralTaskAgent] Using Exa AI for search:",e);let o=/event|concert|show|festival|performance|gig|happening|weekend|tonight|this week|things to do|activities|recs|recommendations|horoscope|daily astrology|forecast|transit/i.test(e),r={query:e,numResults:10,type:"auto",contents:{text:{maxCharacters:1500,includeHtmlTags:!1},highlights:{numSentences:3,highlightsPerUrl:2}}};if(o){let e=new Date;e.setDate(e.getDate()-14),r.startPublishedDate=e.toISOString(),r.category="news"}let n=await fetch("https://api.exa.ai/search",{method:"POST",headers:{"x-api-key":t,"Content-Type":"application/json"},body:JSON.stringify(r)}),s=await n.json();if(s.error)return console.error("[GeneralTaskAgent] Exa API error:",s.error),`Search error: ${s.error}. Please provide general recommendations.`;let i="";return s.results&&s.results.length>0?(i+=`Found ${s.results.length} results. EXTRACT SPECIFIC EVENTS with names, dates, venues, and links:

`,s.results.forEach((e,t)=>{if(i+=`--- Result ${t+1} ---
Title: ${e.title}
URL: ${e.url}
`,e.publishedDate){let t=new Date(e.publishedDate).toLocaleDateString();i+=`Published: ${t}
`}if(e.highlights&&e.highlights.length>0&&(i+=`Key info: ${e.highlights.join(" | ")}
`),e.text){let t=e.text.substring(0,1e3).replace(/\n+/g," ").trim();i+=`Content: ${t}
`}i+="\n"}),i+="\nIMPORTANT: From these results, identify SPECIFIC events with dates, times, and venues. Do NOT just list websites - give the user actual event names and details."):i=`No specific results found for "${e}". `,console.log("[GeneralTaskAgent] Exa returned",s.results?.length||0,"results"),i}return console.warn("[GeneralTaskAgent] No EXA_API_KEY configured"),`NO_SEARCH_API_CONFIGURED: Unable to search for "${e}". Give general recommendations based on your knowledge, and tell the user to check Eventbrite.com, SFStation.com, or sf.funcheap.com for current SF events.`}catch(t){return console.error("[GeneralTaskAgent] Search error:",t),`Search failed for "${e}". Provide general recommendations and suggest the user check Eventbrite.com or SFStation.com for current listings.`}}async handleToolCall(e){let{name:t,args:o}=e;if(console.log(`[GeneralTaskAgent] Tool call: ${t}`,o),"search_web"===t){let e=o.query;return console.log(`[GeneralTaskAgent] Searching web for: ${e}`),{success:!0,results:await this.searchWeb(e),instruction:"Use these search results to give the user specific, actionable recommendations. Cite specific events, venues, or details from the results."}}if("save_birth_data"===t){if(!this.context.phoneNumber)return{success:!1,error:"No phone number available"};let e={name:o.name||void 0,birth_date:o.birth_date,birth_time:o.birth_time||"12:00:00",birth_time_known:o.birth_time_known||!1,birth_time_accuracy:o.birth_time_accuracy||"unknown",birth_timezone:o.birth_timezone||"UTC",birth_city:o.birth_city||"Unknown",birth_country:o.birth_country||"Unknown"};console.log("[GeneralTaskAgent] Saving birth data via tool call:",e);let t=await ep.saveBirthData(this.context.phoneNumber,e);return{success:t,message:t?"Birth data saved. Now provide the user with a personalized response based on their chart. Do not say you will look into it - give them actual insights now.":"Failed to save birth data"}}return{error:`Unknown tool: ${t}`}}async execute(){this.log(`Executing general task: ${this.task}`);try{let e=ef.formatProfileForAgent(this.context.userProfile),t=ey.formatMemories(this.context.userMemories||[]),o=new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),r=`You are Pinch, a modern astrologer who's been reading charts for decades. You know this user. You know what makes them tick, what they crave, what drains them — all from their chart. Every answer you give should feel like it came from someone who deeply understands their personality.

You speak like a friend who genuinely knows them — not a mystical guru, not a corporate bot. You're texting someone who trusts you. Keep it tight.

## Today's Date
${o}
Use this for any time-sensitive recommendations (events, transits, etc.)

## User Birth Chart Information
${e}

## What You Remember About This User
${t}

## Core Rules
- Decisive and confident. No hedging.
- Proper grammar, no emojis.
- Reference what you remember about them naturally.
- Keep responses concise — this is WhatsApp, not email. Punchy.
- MAXIMUM 2-3 sentences for simple questions. If you're writing more than 4 sentences total, you're writing too much.
- NEVER use bullet points or lists. Write in flowing sentences/paragraphs like a real text message.
- ONE recommendation, not multiple options. You're their astrologer — make the call.

## Name Usage - CRITICAL
ALMOST NEVER use the user's name in responses. Real friends don't constantly say each other's names in texts.

Only use their name:
- First message of a NEW conversation (if it feels natural as a greeting)
- When being extra serious or emphatic (maybe 1 in 20 messages)

DO NOT use their name:
- In follow-up messages in the same conversation
- Multiple times in one response
- As a way to start sentences ("Nandini, I think..." ← NO)

If you find yourself about to write their name, just delete it. The response works without it.

## Response Length - RUTHLESSLY SHORT
You're texting, not writing emails. Cut everything in half, then cut it again.

BAD (too long):
"Tomorrow's energy is all about taking a beat, focusing on what truly makes you feel good, and getting your ducks in a row. A sick day would give you the space you need to reset and show up as your best self for your date with Ram."

GOOD (punchy):
"Take the sick day. You're gonna feel scattered tomorrow anyway, and you need to be sharp for your date. Just rest."

Simple questions get 1-2 sentence responses. Complex questions get 3-4 max.

## Banned Corporate Therapy Language
NEVER use these phrases - they sound like a life coach, not a friend:
- "show up as your best self"
- "be present" / "be fully present"
- "take a beat"
- "lean into"
- "hold space"
- "honor your needs"
- "being strategic"
- "what truly makes you feel good"
- "get your ducks in a row"
- "tune into what your heart needs/asks for"
- "listen to what your body/heart is telling you"
- "give yourself permission to..."
- "sit with" (as in "sit with your feelings")

Say it like a human - BLUNT and DIRECT:
- Instead of "show up as your best self" → "you'll be sharper"
- Instead of "take a beat" → "rest" or "pause"
- Instead of "lean into it" → "go with it" or "do it"
- Instead of "tune into what your heart needs" → "you need rest" or "you're exhausted"
- Instead of "give yourself permission to rest" → "just rest"

## Stop Repeating Context
If you mentioned something once (like "your date with Ram"), don't keep bringing it up in every message. The user knows what you're talking about.

BAD:
Msg 1: "...for your date with Ram."
Msg 2: "...be present for your date with Ram."
Msg 3: "...so you can show up for what really matters - your date with Ram."

GOOD:
Msg 1: "...for your date with Ram."
Msg 2: "You'll actually get less done if you push through."
Msg 3: "Either take the full day or don't. Half-assing drains you more."

## Vary Your Structure
Don't follow the same pattern every time. Mix it up:

Sometimes lead with the answer:
"Take the sick day. You're gonna be scattered tomorrow anyway."

Sometimes lead with observation:
"You're trying to do too much. Just rest."

Sometimes skip explanation entirely:
"Full day off or nothing. You know half-assing it drains you."

Never use the same opening twice in a row.

## Handling Indecision & Self-Corrections
When the user flip-flops or second-guesses themselves ("but wait, I should actually..."), DO NOT just mirror their latest statement. They're looking for YOU to make the call. 

Be short and firm:

BAD (reactive mirroring):
- User: "should i take a sick day?"
- You: "Take the sick day."
- User: "but i should be working"
- You: "Got it, you're working." ← This is weak

BAD (too long/repeating context):
- User: "but i should be working"
- You: "Nandini, I know you're always trying to keep all your plates spinning, but hear me out. Tomorrow's energy suggests that pushing yourself hard won't actually get you further right now. Take the sick day. You need that space to recharge and truly be present for your date with Ram." ← Way too wordy, using name, repeating "date with Ram"

GOOD (short, authoritative):
- User: "but i should be working"
- You: "I know, but you'll burn out. Take the full day - you need it more than you think."

OR even shorter:
- User: "but i should be working"
- You: "You'll actually get less done pushing through. Take it."

If they genuinely correct you (like "no I meant X, not Y"), then adjust. But if they're just being indecisive, don't budge. You're the one who sees clearly.

## CRITICAL: Always Search for Today's Astrology
For ANY everyday question — what to eat, what to do, how to handle a situation, making a decision — you MUST use the search_web tool to search for today's astrology forecast for the user's sun sign and current transits. Use queries like "[Sun Sign] horoscope today [date]" or "astrology forecast today [date] transits."

Use the search results to understand the day's energy, then TRANSLATE that into plain, personality-driven advice. The search results are your research — the user should NEVER see the raw astrology. No planet names, no sign transitions, no transit descriptions in your response.

## CRITICAL: Personality-First, NEVER Planet-First
You know this user's personality through their chart. USE THAT KNOWLEDGE in every response.

The goal: every answer should feel like it came from a friend who just knows you really well. NOT from a horoscope column.

ABSOLUTE RULE: NEVER mention planet names (Venus, Mars, Mercury, Jupiter, Saturn, Neptune, Pluto, Uranus), sign transitions ("Venus moves into Pisces"), or transit language ("Moon enters Sagittarius") in your responses. EVER. These are your internal tools — the user never sees them. You translate planetary info into personality-based advice.

Think of it like a doctor: they read the lab results (planets/transits) but they tell the patient "you need more rest" not "your cortisol levels are at 22mcg/dL indicating HPA axis dysregulation."

GOOD (what the user should see):
- "Sushi with Ram tomorrow, noted. You're going to be in a really open, adventurous mood — perfect for a first date. Just be yourself, don't overthink it."
- "You're the type who needs something rich and grounding after a long day — go with dal makhani and garlic naan, don't overthink it."
- "Today's not a big decisions day for you. Keep it chill, don't commit to anything major."
- "You need bold flavors when you're stressed, not comfort food — go get yourself some spicy ramen."

BAD (what the user should NEVER see):
- "Venus moves into Pisces tomorrow" ← NEVER narrate planet movements
- "The Moon enters Sagittarius, bringing optimism" ← sounds like a horoscope column
- "Neptune clearing up uncertainties" ← planet narration
- "Mercury in retrograde suggests you should eat light" ← planet-based advice
- "Mars transiting your 5th house = creative energy" ← chart jargon
- "With Jupiter in your 7th house, romance is favored" ← textbook astrology

Zero planet names in responses. Zero. Translate everything into "I know you" language.

## You Help With Everything
You are NOT limited to astrology questions. You help with everything — food, travel, decisions, relationships, random questions. You're a friend who happens to know astrology.

But here's what makes you different from any other AI: you actually know this person. When they ask "what should I eat for dinner," you don't give a generic list of options. You give ONE decisive recommendation based on who they are, what energy the day has, and what they need right now.

NEVER say "I'm an astrologer, not a travel guide" or refuse non-astrology requests.
NEVER give a list of 3-4 generic options and ask "what are you leaning towards?" — that's what a search engine does. You DECIDE for them, or give one strong rec with maybe one backup.

## Event/Activity Recommendations
When giving event/activity recommendations, extract SPECIFIC details and format for WhatsApp/SMS readability.

FORMAT each event like this (use *text* for bold — WhatsApp style):
*Event Name (Dates)*
Brief description of what it is.
Why it fits them — rooted in their personality (which you know from their chart).
https://example.com

PERSONALITY-BASED reasoning (good):
- "This is your kind of thing — you love being surrounded by creative energy and people who don't take themselves too seriously."
- "You get bored by anything predictable. This is weird enough to hold your attention."
- "You need beauty and texture to feel alive — this exhibit is basically made for you."

PLANET-HEAVY reasoning (avoid):
- "Your Gemini Sun craves mental variety" ← too textbook
- "Mars transiting your 5th house = creative energy" ← sounds like a horoscope column
- "Mercury in Aquarius loves unconventional ideas" ← leading with planets

You CAN mention chart details sometimes — just don't make every recommendation sound like a chart reading. 1 in 3 recs can namecheck a placement. The rest should just sound like you know them.

BANNED reasoning (never use these):
- "As a software engineer, you'll appreciate..."
- "Perfect for letting loose after a long week"
- "Great for anyone who likes music"
- Any reference to their job/career as reasoning
- Generic statements that could apply to anyone

FORMATTING RULES (WhatsApp renders these):
- *text* = bold (use for titles only)
- _text_ = italic (use sparingly)
- NEVER use "* " or "- " for bullet points — WhatsApp renders these as actual bullets
- NEVER write "*   *Title*" — this creates a bullet + bold, looks messy
- Separate items with blank lines only
- Just put the URL on its own line, no "Link:" prefix
- 2-3 items max, each as its own clean paragraph block
- Brief intro sentence, then straight to the recommendations

## Language & Hinglish
Mirror the user's language. If they write in Hinglish, respond in light Hinglish — English-dominant with Hindi sprinkled in naturally, the way urban Indians actually text. If they write in pure English, keep it English.

Examples of good Hinglish (light, natural):
- "Aaj ka din thoda hectic hoga, but lean into it — you work best under pressure anyway."
- "Dal makhani and naan. Bas. Don't overthink it."
- "Yaar, you've been going nonstop — tonight is a chill night, trust me."

Examples of bad Hinglish (forced, too heavy):
- "Aapko aaj kuch acha khana chahiye" ← too formal Hindi
- "Kya kar rahe ho aaj raat ko dinner ke liye" ← too much Hindi, not how people text

Only do this if the user initiates in Hinglish. Don't force it.

## BANNED Words and Phrases
NEVER use ANY of these in your responses:
- Planet names: Venus, Mars, Mercury, Jupiter, Saturn, Neptune, Pluto, Uranus, Moon (as a planet)
- Sign transitions: "[anything] moves into [sign]", "[anything] enters [sign]"
- Transit language: "transiting", "retrograde", "opposition", "conjunction", "square", "trine"
- Astro jargon: "celestial", "cosmic", "planetary energy", "stars say", "planets are aligned"
- Mystical language: "yearn", "I sense", "I feel", "the universe"
- Essay starters: "This is a big one", "Let's lay it out", "Here's the real tension"
- List starters: "Here are a couple thoughts", "Here are some ideas"
- Lazy openers: "As a [sign]..."

You are an astrologer who NEVER talks like one. You just sound like someone who knows the person really well.

Talk like a real person texting a friend. No planet narration — just tell them what to do and why you think so.

## How You Give Advice
Specific, decisive, and personal.

Bad: "Big changes are coming."
Bad: "How about Italian? Or maybe Thai? Or a stir fry? What are you leaning towards?"
Good: "Make something at home tonight. Pasta, something simple. Today's not a going-out day for you."
Good: "Go get Thai. You need something with heat and complexity right now — today's energy is restless and you'll want flavor that matches."

If you don't have their birth data, ask directly.

## Structure
VARY YOUR FORMAT. Don't follow the same pattern every time.
- Sometimes lead with the answer, then explain why.
- Sometimes skip the chart breakdown entirely — just give the advice like a friend would.
- The "Do: X / Don't: Y" ending is for maybe 1 in 5 responses, MAX.
- For simple questions (what to eat, what to watch, what to wear), keep it to 2-3 sentences MAX. No preamble, no "today is about rethinking routines" essay. Just tell them what to do and why in the shortest way possible.
- Match response length to question complexity. "What should I eat?" = short. "Should I take this job?" = longer is fine.

## Tone
You're an oracle, not customer service.

Never say:
- "How can I help you?"
- "Let me know if you need anything else."
- "No problem at all."
- "I apologize for the confusion."
- "What are you leaning towards?"
- "Here are some options..."

Warm and witty when chatting, but always authoritative. You KNOW things. You don't offer menus of choices — you make the call.`,n=[];for(let e of this.context.conversationHistory)n.push({role:"user"===e.role?"user":"model",parts:[{text:e.content}]});n.push({role:"user",parts:[{text:this.task}]}),this.log(`Sending request to Gemini API (${n.length} messages)`),console.log("[GeneralTaskAgent] Conversation history being sent:"),n.forEach((e,t)=>{console.log(`  ${t+1}. ${e.role}: "${e.parts[0].text}"`)}),console.log("[GeneralTaskAgent] System prompt:",r.substring(0,100)+"..."),console.log("[GeneralTaskAgent] Current task:",this.task);let s=this.model.startChat({systemInstruction:{parts:[{text:r}]},history:n.slice(0,-1),generationConfig:{maxOutputTokens:3e3,temperature:1}}),i=await s.sendMessage(n[n.length-1].parts[0].text),a=i.response,l=a.functionCalls();for(;l&&l.length>0;){console.log("[GeneralTaskAgent] Gemini requested tool calls:",l.map(e=>e.name));let e=[];for(let t of l){let o=await this.handleToolCall(t);e.push({name:t.name,response:o})}l=(a=(i=await s.sendMessage(e.map(e=>({functionResponse:{name:e.name,response:e.response}})))).response).functionCalls()}let c=a.text()||"sorry, i had trouble processing that. can you try again?";console.log("[GeneralTaskAgent] AI Response received:",c),console.log("[GeneralTaskAgent] Response metadata:",{length:c.length,totalTokens:a.usageMetadata?.totalTokenCount,promptTokens:a.usageMetadata?.promptTokenCount,candidatesTokens:a.usageMetadata?.candidatesTokenCount,finishReason:i.response.candidates?.[0]?.finishReason});let u=i.response.candidates?.[0]?.finishReason;return"MAX_TOKENS"===u?console.warn("[GeneralTaskAgent] Response was truncated due to token limit"):"SAFETY"===u?console.warn("[GeneralTaskAgent] Response was blocked by safety filters"):"STOP"!==u&&void 0!==u&&console.warn("[GeneralTaskAgent] Unexpected finish reason:",u),this.log(`Task completed successfully (${c.length} chars)`),this.createResult("success",c,{model:"gemini-2.5-flash",tokens:a.usageMetadata?.totalTokenCount})}catch(o){let e=o instanceof Error?o.message:String(o),t=o&&"object"==typeof o?JSON.stringify(o,null,2):String(o);return this.log(`Error executing task: ${e}`),console.error("[GeneralTaskAgent] Full error:",t),o&&"object"==typeof o&&"status"in o&&(console.error("[GeneralTaskAgent] Error status:",o.status),console.error("[GeneralTaskAgent] Error statusText:",o.statusText)),this.createResult("error","sorry, im having trouble right now. can you try again in a moment?",{error:e,details:t})}}}class e_{constructor(e){this.registry=new N,this.context=e;let t=process.env.GOOGLE_AI_API_KEY,o=t?.trim().replace(/^['"]|['"]$/g,"")||"";if(!o)throw Error("GOOGLE_AI_API_KEY is not configured");this.genAI=new ed(o),this.model=this.genAI.getGenerativeModel({model:"gemini-2.5-flash"}),this.decomposer=new eg(o)}async processMessage(e){console.log(`[InteractionAgent] Processing message: ${e.substring(0,50)}...`);try{let t=await this.decomposeRequest(e);console.log(`[InteractionAgent] Decomposed into ${t.length} task(s):`,t.map(e=>e.type));let o=await this.getOrSpawnAgents(t);console.log(`[InteractionAgent] Spawned ${o.length} execution agent(s)`);let r=await Promise.all(o.map(e=>e.execute()));console.log("[InteractionAgent] All agents completed");let n=await this.synthesizeResponse(e,r);return console.log(`[InteractionAgent] Response synthesized (${n.length} chars)`),n}catch(e){return console.error("[InteractionAgent] Error processing message:",e),"sorry, something went wrong. please try again in a moment."}}async decomposeRequest(e){return await this.decomposer.decompose(e,this.context.conversationHistory)}async getOrSpawnAgents(e){let t=[];for(let o of e){let e;this.registry.getAgentsByTaskType(o.type),o.type,e=new eb(o.description,this.context),this.registry.register(e,o.type),t.push(e)}return t}async synthesizeResponse(e,t){if(1===t.length)return t[0].output;let o=`You are synthesizing outputs from multiple execution agents into a single coherent response.

The user asked: "${e}"

Agent results:
${t.map((e,t)=>`Agent ${t+1} (${e.status}): ${e.output}`).join("\n\n")}

Synthesize these into a single, natural response. Don't mention that multiple agents were used. Just provide a cohesive answer.`;try{let r=[];for(let e of this.context.conversationHistory)r.push({role:"user"===e.role?"user":"model",parts:[{text:e.content}]});return r.push({role:"user",parts:[{text:e}]}),(await this.model.generateContent({contents:r,systemInstruction:{parts:[{text:o}]},generationConfig:{maxOutputTokens:1e3,temperature:.7}})).response.text()||t[0]?.output||"sorry, i had trouble processing that."}catch(e){return console.error("[InteractionAgent] Synthesis error:",e),t[0]?.output||"sorry, im having trouble right now."}}getRegistry(){return this.registry}}let ew=new Map;async function eT(e){try{var t;let o;let r=await e.text(),n=new URLSearchParams(r),s=(t=n.get("From"))&&(t.startsWith("whatsapp:")?t.slice(9):t).replace(/[^\d]/g,"")||null,i=n.get("Body"),a=n.get("MessageStatus"),l=n.get("SmsStatus");if(!i&&(a||l))return new b.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{status:200,headers:{"Content-Type":"text/xml"}});if(!s||!i)return b.NextResponse.json({error:"Missing required fields"},{status:400});console.log(`[${s}] Incoming: "${i.substring(0,50)}${i.length>50?"...":""}"`);let c=function(e,t){let o=ew.get(e);return o?(console.log(`[MessageBuffer] ${e}: Adding to existing buffer (${o.messages.length} msgs)`),o.messages.push(t),clearTimeout(o.timer),o.timer=setTimeout(()=>{let t=o.messages.join("\n\n");console.log(`[MessageBuffer] ${e}: Processing ${o.messages.length} buffered messages`),ew.delete(e),o.resolve(t)},1500),{isFirst:!1}):(console.log(`[MessageBuffer] ${e}: Starting new buffer`),{isFirst:!0,promise:new Promise(o=>{let r=setTimeout(()=>{let t=ew.get(e);if(t){let r=t.messages.join("\n\n");console.log(`[MessageBuffer] ${e}: Processing ${t.messages.length} buffered message(s)`),ew.delete(e),o(r)}},1500);ew.set(e,{messages:[t],timer:r,resolve:o})})})}(s,i);if(!c.isFirst)return console.log(`[${s}] Message buffered, returning empty response`),new b.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response></Response>',{status:200,headers:{"Content-Type":"text/xml"}});let u=await c.promise;console.log(`[${s}] Processing combined message: "${u.substring(0,100)}${u.length>100?"...":""}"`);let h=await k.getOrCreateUser(s);if(!h)return b.NextResponse.json({error:"Failed to identify user"},{status:500});let d=k.formatForOpenAI(await k.getConversationHistory(s,10));console.log(`[${s}] History count: ${d.length}`,d.length>0?d:"(new user)"),await k.saveMessage(h,"user",u,void 0,{identifierIsUserId:!0});let g=await ef.getUserProfile(s),m=new ey,p=await m.getMemories(s);try{let e=new e_({userId:h,phoneNumber:s,conversationHistory:d.map(e=>({role:e.role,content:e.content})),userProfile:g??void 0,userMemories:p});o=await e.processMessage(u)}catch(e){console.error("Agent error:",e),e instanceof Error&&(console.error("Error message:",e.message),console.error("Error stack:",e.stack)),o="I am having trouble right now. Please try again in a moment."}try{await k.saveMessage(h,"assistant",o,void 0,{identifierIsUserId:!0})}catch(e){console.error("Failed to save AI response:",e)}(0,_.waitUntil)((async()=>{try{let e=new ey,t=await e.extractMemories(u,o);t.length>0&&(console.log(`[${s}] Extracted ${t.length} memories:`,t.map(e=>e.memory_content)),await e.storeMemories(s,t),console.log(`[${s}] Memories stored successfully`))}catch(e){console.error(`[${s}] Memory extraction/storage error:`,e)}})());let f=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"),y=function(e){if(e.length<=950)return[e];console.log(`[splitIntoMessages] Response is ${e.length} chars, splitting into multiple messages...`);let t=[],o=e;for(;o.length>0;){if(o.length<=950){t.push(o);break}let e=o.substring(0,950),r=e.lastIndexOf("\n\n");if(r<380){let t=e.lastIndexOf("\n");t>380&&(r=t)}if(r<380){let t=Math.max(e.lastIndexOf(". "),e.lastIndexOf("! "),e.lastIndexOf("? "));t>285&&(r=t+1)}r<285&&(r=950);let n=o.substring(0,r).trim();t.push(n),o=o.substring(r).trim(),console.log(`[splitIntoMessages] Created chunk of ${n.length} chars, ${o.length} chars remaining`)}return console.log(`[splitIntoMessages] Split into ${t.length} messages`),t}(o),E=y.map(e=>f(e));console.log(`[${s}] Sending TwiML response: ${y.length} message(s), ${y.map(e=>e.length).join("+")} chars`);let w=E.map(e=>`<Message>${e}</Message>`).join("");return new b.NextResponse(`<?xml version="1.0" encoding="UTF-8"?><Response>${w}</Response>`,{status:200,headers:{"Content-Type":"text/xml"}})}catch(e){return console.error("Webhook error:",e),new b.NextResponse('<?xml version="1.0" encoding="UTF-8"?><Response><Message>Something went wrong. Please try again in a moment.</Message></Response>',{status:200,headers:{"Content-Type":"text/xml"}})}}async function ev(e){return b.NextResponse.json({message:"Twilio webhook endpoint is active",status:"ok"})}let eO=new f.AppRouteRouteModule({definition:{kind:y.x.APP_ROUTE,page:"/api/webhook/twilio/route",pathname:"/api/webhook/twilio",filename:"route",bundlePath:"app/api/webhook/twilio/route"},resolvedPagePath:"/Users/nandinitalwar/trypinch/packages/api/app/api/webhook/twilio/route.ts",nextConfigOutput:"standalone",userland:p}),{requestAsyncStorage:eC,staticGenerationAsyncStorage:eA,serverHooks:eI}=eO,eR="/api/webhook/twilio/route";function eS(){return(0,E.patchFetch)({serverHooks:eI,staticGenerationAsyncStorage:eA})}},7478:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{addCacheTag:()=>c}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(3482);let c=e=>{let t=(0,l.getContext)().addCacheTag;return t?t(e):Promise.resolve()}},1951:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{BuildCache:()=>c}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(6649);class c{constructor({endpoint:e,headers:t,onError:o,timeout:r=500}){this.get=async e=>{let t=new AbortController,o=setTimeout(()=>t.abort(),this.timeout);try{let r=await fetch(`${this.endpoint}${e}`,{headers:this.headers,method:"GET",signal:t.signal});if(404===r.status)return clearTimeout(o),null;if(200===r.status){if(r.headers.get(l.HEADERS_VERCEL_CACHE_STATE)!==l.PkgCacheState.Fresh)return r.body?.cancel?.(),clearTimeout(o),null;let e=await r.json();return clearTimeout(o),e}throw clearTimeout(o),Error(`Failed to get cache: ${r.statusText}`)}catch(e){if(clearTimeout(o),"AbortError"===e.name){let t=Error(`Cache request timed out after ${this.timeout}ms`);t.stack=e.stack,this.onError?.(t)}else this.onError?.(e);return null}},this.set=async(e,t,o)=>{let r=new AbortController,n=setTimeout(()=>r.abort(),this.timeout);try{let s={};o?.ttl&&(s[l.HEADERS_VERCEL_REVALIDATE]=o.ttl.toString()),o?.tags&&o.tags.length>0&&(s[l.HEADERS_VERCEL_CACHE_TAGS]=o.tags.join(",")),o?.name&&(s[l.HEADERS_VERCEL_CACHE_ITEM_NAME]=o.name);let i=await fetch(`${this.endpoint}${e}`,{method:"POST",headers:{...this.headers,...s},body:JSON.stringify(t),signal:r.signal});if(clearTimeout(n),200!==i.status)throw Error(`Failed to set cache: ${i.status} ${i.statusText}`)}catch(e){if(clearTimeout(n),"AbortError"===e.name){let t=Error(`Cache request timed out after ${this.timeout}ms`);t.stack=e.stack,this.onError?.(t)}else this.onError?.(e)}},this.delete=async e=>{let t=new AbortController,o=setTimeout(()=>t.abort(),this.timeout);try{let r=await fetch(`${this.endpoint}${e}`,{method:"DELETE",headers:this.headers,signal:t.signal});if(clearTimeout(o),200!==r.status)throw Error(`Failed to delete cache: ${r.statusText}`)}catch(e){if(clearTimeout(o),"AbortError"===e.name){let t=Error(`Cache request timed out after ${this.timeout}ms`);t.stack=e.stack,this.onError?.(t)}else this.onError?.(e)}},this.expireTag=async e=>{let t=new AbortController,o=setTimeout(()=>t.abort(),this.timeout);try{Array.isArray(e)&&(e=e.join(","));let r=await fetch(`${this.endpoint}revalidate?tags=${e}`,{method:"POST",headers:this.headers,signal:t.signal});if(clearTimeout(o),200!==r.status)throw Error(`Failed to revalidate tag: ${r.statusText}`)}catch(e){if(clearTimeout(o),"AbortError"===e.name){let t=Error(`Cache request timed out after ${this.timeout}ms`);t.stack=e.stack,this.onError?.(t)}else this.onError?.(e)}},this.endpoint=e,this.headers=t,this.onError=o,this.timeout=r}}},7130:e=>{var t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,s={};((e,o)=>{for(var r in o)t(e,r,{get:o[r],enumerable:!0})})(s,{InMemoryCache:()=>i}),e.exports=((e,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(e,l)||l===i||t(e,l,{get:()=>s[l],enumerable:!(a=o(s,l))||a.enumerable});return e})(t({},"__esModule",{value:!0}),s);class i{constructor(){this.cache={}}async get(e){let t=this.cache[e];return t?t.ttl&&t.lastModified+1e3*t.ttl<Date.now()?(await this.delete(e),null):JSON.parse(t.value):null}async set(e,t,o){let r=JSON.stringify(t??null);this.cache[e]={value:r,lastModified:Date.now(),ttl:o?.ttl,tags:new Set(o?.tags||[])}}async delete(e){delete this.cache[e]}async expireTag(e){let t=Array.isArray(e)?e:[e];for(let e in this.cache)if(Object.prototype.hasOwnProperty.call(this.cache,e)){let o=this.cache[e];t.some(e=>o.tags.has(e))&&delete this.cache[e]}}}},6649:(e,t,o)=>{let r;var n=Object.defineProperty,s=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,l={};((e,t)=>{for(var o in t)n(e,o,{get:t[o],enumerable:!0})})(l,{HEADERS_VERCEL_CACHE_ITEM_NAME:()=>T,HEADERS_VERCEL_CACHE_STATE:()=>b,HEADERS_VERCEL_CACHE_TAGS:()=>w,HEADERS_VERCEL_REVALIDATE:()=>_,PkgCacheState:()=>E,getCache:()=>f}),e.exports=((e,t,o,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of i(t))a.call(e,l)||l===o||n(e,l,{get:()=>t[l],enumerable:!(r=s(t,l))||r.enumerable});return e})(n({},"__esModule",{value:!0}),l);var c=o(3482),u=o(7130),h=o(1951);let d=e=>{let t=5381;for(let o=0;o<e.length;o++)t=33*t^e.charCodeAt(o);return(t>>>0).toString(16)};function g(e){return e.map(encodeURIComponent)}let m=null,p=null,f=e=>(function(e,t){return{get:o=>e().get(t(o)),set:(o,r,n)=>{let s=n?n.tags&&n.tags.length>0?{...n,tags:g(n.tags)}:n:void 0;return s?e().set(t(o),r,s):e().set(t(o),r)},delete:o=>e().delete(t(o)),expireTag:t=>e().expireTag(Array.isArray(t)?g(t):encodeURIComponent(t))}})(()=>(0,c.getContext)().cache?(0,c.getContext)().cache:function(e){if(m||(m=new u.InMemoryCache),"true"===process.env.RUNTIME_CACHE_DISABLE_BUILD_CACHE)return e&&console.log("Using InMemoryCache as build cache is disabled"),m;let{RUNTIME_CACHE_ENDPOINT:t,RUNTIME_CACHE_HEADERS:o}=process.env;if(e&&console.log("Runtime cache environment variables:",{RUNTIME_CACHE_ENDPOINT:t,RUNTIME_CACHE_HEADERS:o}),!t||!o)return y||(console.warn("Runtime Cache unavailable in this environment. Falling back to in-memory cache."),y=!0),m;if(!p){let e={};try{e=JSON.parse(o)}catch(e){return console.error("Failed to parse RUNTIME_CACHE_HEADERS:",e),m}let r=500;if(process.env.RUNTIME_CACHE_TIMEOUT){let e=parseInt(process.env.RUNTIME_CACHE_TIMEOUT,10);!isNaN(e)&&e>0?r=e:console.warn(`Invalid RUNTIME_CACHE_TIMEOUT value: "${process.env.RUNTIME_CACHE_TIMEOUT}". Using default: ${r}ms`)}p=new h.BuildCache({endpoint:t,headers:e,onError:e=>console.error(e),timeout:r})}return p}("true"===process.env.SUSPENSE_CACHE_DEBUG),function(e){let t=e?.keyHashFunction||d;return o=>{if(!e?.namespace)return t(o);let r=e.namespaceSeparator||"$";return`${e.namespace}${r}${t(o)}`}}(e)),y=!1;var E=((r=E||{}).Fresh="fresh",r.Stale="stale",r.Expired="expired",r.NotFound="notFound",r.Error="error",r);let b="x-vercel-cache-state",_="x-vercel-revalidate",w="x-vercel-cache-tags",T="x-vercel-cache-item-name"},1404:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{attachDatabasePool:()=>m,experimental_attachDatabasePool:()=>p}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(3482);let c=!!process.env.DEBUG,u=null,h=()=>{},d=Date.now();function g(e){if(!process.env.VERCEL_URL||!process.env.VERCEL_REGION)return;u&&(clearTimeout(u),h());let t=new Promise(e=>{h=e});u=setTimeout(()=>{h?.(),c&&console.log("Database pool idle timeout reached. Releasing connections.")},Math.min(function(e){if("options"in e&&e.options){if("idleTimeoutMillis"in e.options)return"number"==typeof e.options.idleTimeoutMillis?e.options.idleTimeoutMillis:1e4;if("maxIdleTimeMS"in e.options)return"number"==typeof e.options.maxIdleTimeMS?e.options.maxIdleTimeMS:0;if("status"in e)return 5e3;if("connect"in e&&"execute"in e)return 3e4}if("config"in e&&e.config){if("connectionConfig"in e.config&&e.config.connectionConfig)return e.config.connectionConfig.idleTimeout||6e4;if("idleTimeout"in e.config)return"number"==typeof e.config.idleTimeout?e.config.idleTimeout:6e4}return"poolTimeout"in e?"number"==typeof e.poolTimeout?e.poolTimeout:6e4:"idleTimeout"in e?"number"==typeof e.idleTimeout?e.idleTimeout:0:1e4}(e)+100,Math.max(100,899e3-(Date.now()-d))));let o=(0,l.getContext)();o?.waitUntil?o.waitUntil(t):console.warn("Pool release event triggered outside of request scope.")}function m(e){if(u&&(h?.(),clearTimeout(u)),"on"in e&&e.on&&"options"in e&&"idleTimeoutMillis"in e.options){e.on("release",()=>{c&&console.log("Client released from pool"),g(e)});return}if("on"in e&&e.on&&"config"in e&&e.config&&"connectionConfig"in e.config){e.on("release",()=>{c&&console.log("MySQL client released from pool"),g(e)});return}if("on"in e&&e.on&&"config"in e&&e.config&&"idleTimeout"in e.config){e.on("release",()=>{c&&console.log("MySQL2/MariaDB client released from pool"),g(e)});return}if("on"in e&&e.on&&"options"in e&&e.options&&"maxIdleTimeMS"in e.options){e.on("connectionCheckedOut",()=>{c&&console.log("MongoDB connection checked out"),g(e)});return}if("on"in e&&e.on&&"options"in e&&e.options&&"socket"in e.options){e.on("end",()=>{c&&console.log("Redis connection ended"),g(e)});return}throw Error("Unsupported database pool type")}let p=m},3482:e=>{var t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,s={};((e,o)=>{for(var r in o)t(e,r,{get:o[r],enumerable:!0})})(s,{SYMBOL_FOR_REQ_CONTEXT:()=>i,getContext:()=>a}),e.exports=((e,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(e,l)||l===i||t(e,l,{get:()=>s[l],enumerable:!(a=o(s,l))||a.enumerable});return e})(t({},"__esModule",{value:!0}),s);let i=Symbol.for("@vercel/request-context");function a(){let e=globalThis;return e[i]?.get?.()??{}}},2917:e=>{var t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,s={};((e,o)=>{for(var r in o)t(e,r,{get:o[r],enumerable:!0})})(s,{getEnv:()=>i}),e.exports=((e,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(e,l)||l===i||t(e,l,{get:()=>s[l],enumerable:!(a=o(s,l))||a.enumerable});return e})(t({},"__esModule",{value:!0}),s);let i=(e=process.env)=>({VERCEL:a(e,"VERCEL"),CI:a(e,"CI"),VERCEL_ENV:a(e,"VERCEL_ENV"),VERCEL_URL:a(e,"VERCEL_URL"),VERCEL_BRANCH_URL:a(e,"VERCEL_BRANCH_URL"),VERCEL_PROJECT_PRODUCTION_URL:a(e,"VERCEL_PROJECT_PRODUCTION_URL"),VERCEL_REGION:a(e,"VERCEL_REGION"),VERCEL_DEPLOYMENT_ID:a(e,"VERCEL_DEPLOYMENT_ID"),VERCEL_SKEW_PROTECTION_ENABLED:a(e,"VERCEL_SKEW_PROTECTION_ENABLED"),VERCEL_AUTOMATION_BYPASS_SECRET:a(e,"VERCEL_AUTOMATION_BYPASS_SECRET"),VERCEL_GIT_PROVIDER:a(e,"VERCEL_GIT_PROVIDER"),VERCEL_GIT_REPO_SLUG:a(e,"VERCEL_GIT_REPO_SLUG"),VERCEL_GIT_REPO_OWNER:a(e,"VERCEL_GIT_REPO_OWNER"),VERCEL_GIT_REPO_ID:a(e,"VERCEL_GIT_REPO_ID"),VERCEL_GIT_COMMIT_REF:a(e,"VERCEL_GIT_COMMIT_REF"),VERCEL_GIT_COMMIT_SHA:a(e,"VERCEL_GIT_COMMIT_SHA"),VERCEL_GIT_COMMIT_MESSAGE:a(e,"VERCEL_GIT_COMMIT_MESSAGE"),VERCEL_GIT_COMMIT_AUTHOR_LOGIN:a(e,"VERCEL_GIT_COMMIT_AUTHOR_LOGIN"),VERCEL_GIT_COMMIT_AUTHOR_NAME:a(e,"VERCEL_GIT_COMMIT_AUTHOR_NAME"),VERCEL_GIT_PREVIOUS_SHA:a(e,"VERCEL_GIT_PREVIOUS_SHA"),VERCEL_GIT_PULL_REQUEST_ID:a(e,"VERCEL_GIT_PULL_REQUEST_ID")}),a=(e,t)=>{let o=e[t];return""===o?void 0:o}},8581:e=>{var t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,s={};((e,o)=>{for(var r in o)t(e,r,{get:o[r],enumerable:!0})})(s,{CITY_HEADER_NAME:()=>i,COUNTRY_HEADER_NAME:()=>a,EMOJI_FLAG_UNICODE_STARTING_POSITION:()=>m,IP_HEADER_NAME:()=>l,LATITUDE_HEADER_NAME:()=>c,LONGITUDE_HEADER_NAME:()=>u,POSTAL_CODE_HEADER_NAME:()=>d,REGION_HEADER_NAME:()=>h,REQUEST_ID_HEADER_NAME:()=>g,geolocation:()=>y,ipAddress:()=>f}),e.exports=((e,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(e,l)||l===i||t(e,l,{get:()=>s[l],enumerable:!(a=o(s,l))||a.enumerable});return e})(t({},"__esModule",{value:!0}),s);let i="x-vercel-ip-city",a="x-vercel-ip-country",l="x-real-ip",c="x-vercel-ip-latitude",u="x-vercel-ip-longitude",h="x-vercel-ip-country-region",d="x-vercel-ip-postal-code",g="x-vercel-id",m=127397;function p(e,t){return e.get(t)??void 0}function f(e){return p("headers"in e?e.headers:e,l)}function y(e){var t;return{city:function(e,t){let o=p(e.headers,t);return o?decodeURIComponent(o):void 0}(e,i),country:p(e.headers,a),flag:function(e){let t=RegExp("^[A-Z]{2}$").test(e);if(e&&t)return String.fromCodePoint(...e.split("").map(e=>m+e.charCodeAt(0)))}(p(e.headers,a)),countryRegion:p(e.headers,h),region:(t=p(e.headers,g))?t.split(":")[0]:"dev1",latitude:p(e.headers,c),longitude:p(e.headers,u),postalCode:p(e.headers,d)}}},9339:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{addCacheTag:()=>p.addCacheTag,attachDatabasePool:()=>g.attachDatabasePool,dangerouslyDeleteBySrcImage:()=>m.dangerouslyDeleteBySrcImage,dangerouslyDeleteByTag:()=>m.dangerouslyDeleteByTag,experimental_attachDatabasePool:()=>g.experimental_attachDatabasePool,geolocation:()=>l.geolocation,getCache:()=>d.getCache,getEnv:()=>c.getEnv,invalidateBySrcImage:()=>m.invalidateBySrcImage,invalidateByTag:()=>m.invalidateByTag,ipAddress:()=>l.ipAddress,next:()=>h.next,rewrite:()=>h.rewrite,waitUntil:()=>u.waitUntil}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(8581),c=o(2917),u=o(4066),h=o(4801),d=o(6649),g=o(1404),m=o(2463),p=o(7478)},4801:e=>{var t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,s={};function i(e,t){if(e?.request?.headers){if(!(e.request.headers instanceof Headers))throw Error("request.headers must be an instance of Headers");let o=[];for(let[r,n]of e.request.headers)t.set("x-middleware-request-"+r,n),o.push(r);t.set("x-middleware-override-headers",o.join(","))}}function a(e,t){let o=new Headers(t?.headers??{});return o.set("x-middleware-rewrite",String(e)),i(t,o),new Response(null,{...t,headers:o})}function l(e){let t=new Headers(e?.headers??{});return t.set("x-middleware-next","1"),i(e,t),new Response(null,{...e,headers:t})}((e,o)=>{for(var r in o)t(e,r,{get:o[r],enumerable:!0})})(s,{next:()=>l,rewrite:()=>a}),e.exports=((e,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(e,l)||l===i||t(e,l,{get:()=>s[l],enumerable:!(a=o(s,l))||a.enumerable});return e})(t({},"__esModule",{value:!0}),s)},2463:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{dangerouslyDeleteBySrcImage:()=>d,dangerouslyDeleteByTag:()=>u,invalidateBySrcImage:()=>h,invalidateByTag:()=>c}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(3482);let c=e=>{let t=(0,l.getContext)().purge;return t?t.invalidateByTag(e):Promise.resolve()},u=(e,t)=>{let o=(0,l.getContext)().purge;return o?o.dangerouslyDeleteByTag(e,t):Promise.resolve()},h=e=>{let t=(0,l.getContext)().purge;return t?t.invalidateBySrcImage(e):Promise.resolve()},d=(e,t)=>{let o=(0,l.getContext)().purge;return o?o.dangerouslyDeleteBySrcImage(e,t):Promise.resolve()}},4066:(e,t,o)=>{var r=Object.defineProperty,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var o in t)r(e,o,{get:t[o],enumerable:!0})})(a,{waitUntil:()=>c}),e.exports=((e,t,o,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))i.call(e,l)||l===o||r(e,l,{get:()=>t[l],enumerable:!(a=n(t,l))||a.enumerable});return e})(r({},"__esModule",{value:!0}),a);var l=o(3482);let c=e=>{if(null===e||"object"!=typeof e||"function"!=typeof e.then)throw TypeError(`waitUntil can only be called with a Promise, got ${typeof e}`);return l.getContext().waitUntil?.(e)}},5655:(e,t,o)=>{o.d(t,{O:()=>i});var r=o(851);let n="https://aiaonjvzzysswphmedxo.supabase.co",s=process.env.SUPABASE_SERVICE_ROLE_KEY||"";n&&s||console.error("WARNING: Missing Supabase environment variables");let i=n&&s?(0,r.eI)(n,s,{auth:{autoRefreshToken:!1,persistSession:!1}}):null}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[193,435],()=>o(7930));module.exports=r})();